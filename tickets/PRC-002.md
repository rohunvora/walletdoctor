# PRC-002: Per-Token Pricing with CoinGecko

## Status: TODO ðŸ“Œ

### Description
Implement proper per-token USD pricing using CoinGecko's free API with intelligent caching to replace the broken PRC-001 SOL spot pricing.

### Prerequisites
- âœ… PRC-001 disabled (PRICE_SOL_SPOT_ONLY=false)
- âœ… Hot-guard PR merged to prevent future incidents

### Goal
Enable production `/v4/positions/export-gpt/{wallet}` to return accurate `current_price_usd` values for each individual token.

### Design

#### 1. CoinGecko Integration
```python
class TokenPriceService:
    """Fetch token prices with CoinGecko fallback"""
    
    def __init__(self):
        self.cache = {}  # In-memory cache (Redis in phase 2)
        self.cache_ttl = 86400  # 24 hours
        self.coingecko_base = "https://api.coingecko.com/api/v3"
        
    async def get_token_price_usd(
        self, 
        token_mint: str,
        token_symbol: str = None
    ) -> Optional[Decimal]:
        # Check cache first
        cached = self._get_cached_price(token_mint)
        if cached:
            return cached
            
        # Try CoinGecko by mint address
        price = await self._fetch_by_mint(token_mint)
        if price:
            self._cache_price(token_mint, price)
            return price
            
        # Fallback to symbol search if available
        if token_symbol:
            price = await self._fetch_by_symbol(token_symbol)
            if price:
                self._cache_price(token_mint, price)
                return price
                
        return None
```

#### 2. Integration Points

**UnrealizedPnLCalculator**:
```python
# Replace SOL spot pricing with per-token pricing
if should_use_token_pricing():
    price_service = TokenPriceService()
    
    for position in positions:
        price = await price_service.get_token_price_usd(
            position.token_mint,
            position.token_symbol
        )
        
        if price:
            # Calculate with proper decimals
            human_balance = position.balance / Decimal(10 ** position.decimals)
            current_value_usd = human_balance * price
            # ... rest of calculation
```

#### 3. Caching Strategy
- **24-hour cache**: Token prices rarely change significantly in production context
- **In-memory first**: Simple dict cache for MVP
- **Redis phase 2**: Production-grade caching with CCH-001

#### 4. Rate Limiting Protection
- Max 1 API call per unique token mint per 24h
- Batch requests when possible (CoinGecko supports up to 100 tokens)
- Graceful degradation on rate limit

### Implementation Steps

1. **Create TokenPriceService** (`src/lib/token_price_service.py`)
   - CoinGecko API integration
   - In-memory caching with TTL
   - Proper error handling and logging

2. **Feature Flag** (`TOKEN_PRICE_ENABLED`)
   - Default: false
   - Gradual rollout capability

3. **Update UnrealizedPnLCalculator**
   - Replace SOL spot pricing branch
   - Add proper decimal handling
   - Set price_source="coingecko_cached"

4. **Add Tests**
   - âœ… Happy path pricing
   - âœ… Cache hit/miss scenarios
   - âœ… Network failure graceful degradation
   - âœ… Rate limit handling

### Acceptance Criteria
- âœ… â‰¥90% positions priced for demo wallets
- âœ… Response time <5s for cold fetch
- âœ… Cache hit rate >95% after warmup
- âœ… No errors on CoinGecko unavailability
- âœ… Proper decimal handling (no more $4.6B portfolios!)

### Testing Commands
```bash
# Enable token pricing
export TOKEN_PRICE_ENABLED=true

# Test demo wallet
curl -H "X-Api-Key:$API_KEY" \
  "$URL/v4/positions/export-gpt/34zYDgjy..." \
  | jq '.positions[] | {
      token: .token_symbol,
      price: .current_price_usd,
      source: .price_source,
      confidence: .price_confidence
    }'

# Expected output:
# {
#   "token": "BONK",
#   "price": "0.00003145",
#   "source": "coingecko_cached",
#   "confidence": "high"
# }
```

### Out of Scope
- Historical price tracking
- Multiple price source aggregation
- On-chain AMM price discovery
- Redis caching (separate ticket CCH-001)

### Definition of Done
- Token pricing service implemented and tested
- Feature flag enables clean rollout
- Demo wallet shows accurate USD values
- ChatGPT can meaningfully discuss portfolio values 